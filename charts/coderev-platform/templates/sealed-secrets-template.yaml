{{- /*
  Sealed Secrets Template
  
  This template creates SealedSecret resources that can be safely
  committed to version control. The actual secrets are encrypted
  using the sealed-secrets controller's public key.
  
  To create sealed secrets:
  1. Create a plain secret YAML file
  2. Run: kubeseal --format yaml < secret.yaml > sealed-secret.yaml
  3. Apply the sealed secret to the cluster
*/ -}}

# Instructions for creating sealed secrets
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sealed-secrets-instructions
  namespace: platform-control-plane
  labels:
    {{- include "coderev.labels" . | nindent 4 }}
data:
  README.md: |
    # Sealed Secrets Setup
    
    ## Prerequisites
    - Install sealed-secrets controller in your cluster
    - Have kubeseal CLI installed locally
    
    ## Creating Secrets
    
    ### 1. Database Credentials
    ```bash
    kubectl create secret generic database-credentials \
      --namespace={{ .Values.versions.v2.namespace }} \
      --from-literal=url='postgresql://user:password@host:5432/db' \
      --dry-run=client -o yaml | \
      kubeseal --format yaml > database-sealed.yaml
    ```
    
    ### 2. Redis Credentials
    ```bash
    kubectl create secret generic redis-credentials \
      --namespace={{ .Values.versions.v2.namespace }} \
      --from-literal=url='redis://:password@host:6379/0' \
      --dry-run=client -o yaml | \
      kubeseal --format yaml > redis-sealed.yaml
    ```
    
    ### 3. AI Provider API Keys
    ```bash
    kubectl create secret generic openai-secret \
      --namespace={{ .Values.versions.v2.namespace }} \
      --from-literal=api-key='sk-...' \
      --dry-run=client -o yaml | \
      kubeseal --format yaml > openai-sealed.yaml
    ```
    
    ## Applying Sealed Secrets
    ```bash
    kubectl apply -f database-sealed.yaml
    kubectl apply -f redis-sealed.yaml
    kubectl apply -f openai-sealed.yaml
    ```

---
# Example SealedSecret structure (replace encrypted data)
{{- if .Values.sealedSecrets.enabled | default false }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: database-credentials
  namespace: {{ .Values.versions.v2.namespace }}
  labels:
    {{- include "coderev.labels" . | nindent 4 }}
spec:
  encryptedData:
    url: "<SEALED_DATA_HERE>"
  template:
    metadata:
      name: database-credentials
      namespace: {{ .Values.versions.v2.namespace }}
    type: Opaque
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: redis-credentials
  namespace: {{ .Values.versions.v2.namespace }}
  labels:
    {{- include "coderev.labels" . | nindent 4 }}
spec:
  encryptedData:
    url: "<SEALED_DATA_HERE>"
  template:
    metadata:
      name: redis-credentials
      namespace: {{ .Values.versions.v2.namespace }}
    type: Opaque
{{- end }}
