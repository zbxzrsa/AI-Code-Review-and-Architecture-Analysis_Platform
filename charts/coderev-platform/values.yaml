# Default values for coderev-platform
# Three-Version Self-Evolving Architecture

# Global settings
global:
  imageRegistry: gcr.io/coderev-platform
  imagePullSecrets: []
  storageClass: ""

# ============================================================
# Version Configuration
# ============================================================
versions:
  # V1 Experiment Zone
  v1:
    enabled: true
    namespace: platform-v1-exp
    replicas: 1
    autoscaling:
      enabled: true
      minReplicas: 0
      maxReplicas: 10
      targetCPUUtilization: 70
      scaleDownDelay: 300 # 5 minutes
    resources:
      limits:
        cpu: "2"
        memory: "4Gi"
      requests:
        cpu: "500m"
        memory: "1Gi"
    priorityClass: experiment-priority

  # V2 Stable Zone (Production)
  v2:
    enabled: true
    namespace: platform-v2-stable
    replicas: 3
    autoscaling:
      enabled: true
      minReplicas: 3
      maxReplicas: 20
      targetCPUUtilization: 60
    resources:
      limits:
        cpu: "4"
        memory: "8Gi"
      requests:
        cpu: "1"
        memory: "2Gi"
    priorityClass: production-critical
    podDisruptionBudget:
      enabled: true
      minAvailable: 2

  # V3 Legacy/Quarantine Zone
  v3:
    enabled: true
    namespace: platform-v3-legacy
    replicas: 1
    autoscaling:
      enabled: true
      minReplicas: 0
      maxReplicas: 3
      targetCPUUtilization: 80
    resources:
      limits:
        cpu: "1"
        memory: "2Gi"
      requests:
        cpu: "250m"
        memory: "512Mi"
    priorityClass: legacy-low

# ============================================================
# VCAI Service (Version Control AI)
# ============================================================
vcai:
  image:
    repository: vcai
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 8000

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    hosts:
      - host: api.coderev.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: vcai-tls
        hosts:
          - api.coderev.example.com

  env:
    LOG_LEVEL: INFO
    ENVIRONMENT: production

  probes:
    liveness:
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
    readiness:
      initialDelaySeconds: 15
      periodSeconds: 5
      timeoutSeconds: 3

# ============================================================
# CRAI Service (Code Review AI)
# ============================================================
crai:
  image:
    repository: crai
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 8000

  resources:
    limits:
      cpu: "4"
      memory: "8Gi"
    requests:
      cpu: "1"
      memory: "2Gi"

# ============================================================
# Lifecycle Controller
# ============================================================
lifecycleController:
  enabled: true

  image:
    repository: lifecycle-controller
    tag: latest
    pullPolicy: IfNotPresent

  replicas: 2

  service:
    type: ClusterIP
    port: 8080

  resources:
    limits:
      cpu: "1"
      memory: "2Gi"
    requests:
      cpu: "250m"
      memory: "512Mi"

  config:
    evaluationIntervalSeconds: 300
    promotionThresholds:
      p95LatencyMs: 3000
      errorRate: 0.02
      accuracyDelta: 0.02
      securityPassRate: 0.99
      costIncreaseMax: 0.10
      statisticalSignificanceP: 0.05

# ============================================================
# Evaluation Pipeline
# ============================================================
evaluationPipeline:
  enabled: true

  image:
    repository: evaluation-pipeline
    tag: latest
    pullPolicy: IfNotPresent

  replicas: 1

  service:
    type: ClusterIP
    port: 8080

  resources:
    limits:
      cpu: "2"
      memory: "4Gi"
    requests:
      cpu: "500m"
      memory: "1Gi"

# ============================================================
# Semantic Cache (Offline Mode)
# ============================================================
semanticCache:
  enabled: false # Enable for offline deployments

  image:
    repository: semantic-cache
    tag: latest

  replicas: 2

  config:
    similarityThreshold: 0.92
    maxCacheSizeMB: 50000
    ttlHours: 168

# ============================================================
# Frontend
# ============================================================
frontend:
  enabled: true

  image:
    repository: frontend
    tag: latest
    pullPolicy: IfNotPresent

  replicas: 2

  service:
    type: ClusterIP
    port: 80

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - host: coderev.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: frontend-tls
        hosts:
          - coderev.example.com

# ============================================================
# Gateway (Traffic Routing)
# ============================================================
gateway:
  shadowTraffic:
    enabled: true
    percentage: 100

  grayScale:
    enabled: true
    phases: [1, 5, 25, 50, 100]
    pauseBetweenPhases: true

  featureFlags:
    provider: flagsmith # or unleash, launchdarkly
    apiUrl: ""
    apiKey: ""

# ============================================================
# Argo Rollouts
# ============================================================
argoRollouts:
  enabled: true

  analysis:
    enabled: true
    successCondition: "result.successRate >= 0.98"
    failureLimit: 3

# ============================================================
# OPA (Policy Engine)
# ============================================================
opa:
  enabled: true

  image:
    repository: openpolicyagent/opa
    tag: latest

  replicas: 2

  policies:
    configMapName: opa-policies

# ============================================================
# Monitoring
# ============================================================
monitoring:
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s

  grafana:
    enabled: true
    dashboards:
      enabled: true
      configMapName: grafana-dashboards

  alerts:
    enabled: true
    configMapName: prometheus-alerts

# ============================================================
# Database (PostgreSQL)
# ============================================================
postgresql:
  enabled: true
  auth:
    username: platform
    database: platform
    existingSecret: postgresql-secret
  primary:
    persistence:
      size: 100Gi
  readReplicas:
    replicaCount: 2

# ============================================================
# Cache (Redis)
# ============================================================
redis:
  enabled: true
  auth:
    existingSecret: redis-secret
  master:
    persistence:
      size: 10Gi
  replica:
    replicaCount: 2

# ============================================================
# AI Models
# ============================================================
aiModels:
  # Cloud models
  openai:
    enabled: true
    apiKeySecret: openai-secret

  anthropic:
    enabled: true
    apiKeySecret: anthropic-secret

  # Local models (for offline deployment)
  local:
    enabled: false
    codellama:
      enabled: false
      modelPath: /models/codellama-34b
      gpuRequired: true
    deepseek:
      enabled: false
      modelPath: /models/deepseek-coder-33b
      gpuRequired: true

# ============================================================
# Compliance
# ============================================================
compliance:
  mode: standard # standard, financial, hipaa, fedramp, gdpr

  audit:
    enabled: true
    retentionDays: 365

  encryption:
    atRest: true
    inTransit: true

# ============================================================
# Network Policies
# ============================================================
networkPolicies:
  enabled: true

  strictIsolation: true

  allowedNamespaces:
    - platform-control-plane
    - platform-monitoring

# ============================================================
# Resource Quotas
# ============================================================
resourceQuotas:
  enabled: true

  v1:
    cpu: "20"
    memory: "40Gi"
    pods: "50"

  v2:
    cpu: "100"
    memory: "200Gi"
    pods: "100"

  v3:
    cpu: "10"
    memory: "20Gi"
    pods: "20"
