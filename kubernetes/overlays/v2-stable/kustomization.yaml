# V2 Stable Overlay - Production, user-facing, strong SLOs
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: platform-v2-stable

resources:
  - ../../base
  - rollout.yaml
  - hpa.yaml
  - priority-class.yaml
  - resource-quota.yaml
  - pdb.yaml
  - sealed-secrets.yaml

commonLabels:
  version: v2
  environment: production
  tier: stable

patches:
  # V2 gets highest priority and resources
  - target:
      kind: Deployment
      name: vcai-service
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/priorityClassName
        value: production-critical
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          tier: production
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "1000m"
            memory: "2Gi"
          limits:
            cpu: "4000m"
            memory: "8Gi"
      - op: add
        path: /spec/template/spec/topologySpreadConstraints
        value:
          - maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: DoNotSchedule
            labelSelector:
              matchLabels:
                app: vcai-service

  - target:
      kind: Deployment
      name: crai-service
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 5
      - op: add
        path: /spec/template/spec/priorityClassName
        value: production-critical
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2000m"
            memory: "4Gi"

configMapGenerator:
  - name: v2-config
    literals:
      - VERSION=v2
      - ENVIRONMENT=production
      - ENABLE_SHADOW_MODE=false
      - RETURN_RESPONSES=true
      - ENABLE_METRICS=true
      - ENABLE_DETAILED_LOGGING=false
      - SLO_P95_LATENCY_MS=3000
      - SLO_ERROR_RATE_PERCENT=2
      - SLO_AVAILABILITY_PERCENT=99.9
      - MODEL_REGISTRY_URL=http://model-registry.platform-control-plane.svc:8080
      - PROMPT_REGISTRY_URL=http://prompt-registry.platform-control-plane.svc:8080
      - ENABLE_CIRCUIT_BREAKER=true
      - ENABLE_RATE_LIMITING=true
