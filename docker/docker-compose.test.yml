# =============================================================================
# Docker Compose - Testing Environment
# =============================================================================
# Usage:
#   docker-compose -f docker-compose.test.yml up -d
#   docker-compose -f docker-compose.test.yml run --rm test
#   docker-compose -f docker-compose.test.yml down -v
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # Test Database
  # ---------------------------------------------------------------------------
  test-postgres:
    image: postgres:15-alpine
    container_name: test-postgres
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test_db
    ports:
      - "5433:5432"
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ---------------------------------------------------------------------------
  # Test Redis
  # ---------------------------------------------------------------------------
  test-redis:
    image: redis:7-alpine
    container_name: test-redis
    ports:
      - "6380:6379"
    command: redis-server --save "" --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ---------------------------------------------------------------------------
  # Unit Tests Runner
  # ---------------------------------------------------------------------------
  unit-tests:
    build:
      context: ../backend
      dockerfile: Dockerfile.test
    container_name: unit-tests
    environment:
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test:test@test-postgres:5432/test_db
      - REDIS_URL=redis://test-redis:6379/15
      - JWT_SECRET_KEY=test-secret
    volumes:
      - ../backend:/app
      - test-results:/app/test-results
    depends_on:
      test-postgres:
        condition: service_healthy
      test-redis:
        condition: service_healthy
    command: >
      pytest tests/unit/ 
      -v 
      --cov=src 
      --cov-report=xml:/app/test-results/coverage.xml 
      --cov-report=html:/app/test-results/coverage-html
      --junitxml=/app/test-results/junit.xml

  # ---------------------------------------------------------------------------
  # Integration Tests Runner
  # ---------------------------------------------------------------------------
  integration-tests:
    build:
      context: ../backend
      dockerfile: Dockerfile.test
    container_name: integration-tests
    environment:
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test:test@test-postgres:5432/test_db
      - REDIS_URL=redis://test-redis:6379/15
      - AUTH_SERVICE_URL=http://auth-service:8000
      - PROJECT_SERVICE_URL=http://project-service:8000
      - ANALYSIS_SERVICE_URL=http://analysis-service:8000
    volumes:
      - ../backend:/app
      - test-results:/app/test-results
    depends_on:
      test-postgres:
        condition: service_healthy
      test-redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      project-service:
        condition: service_healthy
    command: >
      pytest tests/integration/ 
      -v 
      --junitxml=/app/test-results/integration-junit.xml

  # ---------------------------------------------------------------------------
  # Services Under Test
  # ---------------------------------------------------------------------------
  auth-service:
    build:
      context: ../backend/services/auth-service
      dockerfile: Dockerfile
    environment:
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test:test@test-postgres:5432/test_db
      - REDIS_URL=redis://test-redis:6379/0
      - JWT_SECRET_KEY=test-secret
    depends_on:
      test-postgres:
        condition: service_healthy
      test-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  project-service:
    build:
      context: ../backend/services/project-service
      dockerfile: Dockerfile
    environment:
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test:test@test-postgres:5432/test_db
      - REDIS_URL=redis://test-redis:6379/1
      - AUTH_SERVICE_URL=http://auth-service:8000
    depends_on:
      test-postgres:
        condition: service_healthy
      test-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # Load Testing
  # ---------------------------------------------------------------------------
  locust-master:
    image: locustio/locust:2.20.0
    container_name: locust-master
    ports:
      - "8089:8089"
    volumes:
      - ../tests/load:/mnt/locust
    command: >
      -f /mnt/locust/locustfile.py 
      --master 
      --host=http://api-gateway
    depends_on:
      - auth-service
      - project-service
    profiles:
      - load-test

  locust-worker:
    image: locustio/locust:2.20.0
    volumes:
      - ../tests/load:/mnt/locust
    command: >
      -f /mnt/locust/locustfile.py 
      --worker 
      --master-host=locust-master
    depends_on:
      - locust-master
    deploy:
      replicas: 4
    profiles:
      - load-test

  # ---------------------------------------------------------------------------
  # Security Scanning
  # ---------------------------------------------------------------------------
  trivy-scanner:
    image: aquasec/trivy:latest
    container_name: trivy-scanner
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - trivy-cache:/root/.cache/trivy
      - ../:/workspace
    command: >
      image --severity HIGH,CRITICAL 
      --format json 
      --output /workspace/test-results/trivy-report.json
      auth-service:latest
    profiles:
      - security-scan

  # ---------------------------------------------------------------------------
  # API Gateway for Testing
  # ---------------------------------------------------------------------------
  api-gateway:
    image: nginx:alpine
    container_name: test-api-gateway
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth-service
      - project-service
    profiles:
      - load-test

volumes:
  test-results:
  trivy-cache:

networks:
  default:
    name: test-network
