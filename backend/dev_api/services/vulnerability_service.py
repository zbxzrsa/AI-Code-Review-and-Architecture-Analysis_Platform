"""
Vulnerability Handling Business Logic Service

Handles vulnerability operations:
- Vulnerability scanning
- Risk assessment
- Fix generation
- Tracking and reporting

Module Size: ~200 lines (target < 2000)
"""

from datetime import datetime, timezone
from dataclasses import dataclass
from typing import Any, Dict, List, Optional
from enum import Enum
import hashlib
import re

from ..config import logger


class VulnSeverity(str, Enum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


@dataclass
class ScanResult:
    """Vulnerability scan result."""
    scan_id: str
    project_id: str
    vulnerabilities_found: int
    critical_count: int
    high_count: int
    medium_count: int
    low_count: int
    started_at: str
    completed_at: str
    duration_seconds: float
    files_scanned: int


class VulnerabilityService:
    """
    Service for vulnerability scanning and management.
    
    Provides:
    - Security scanning
    - Vulnerability detection
    - Risk scoring
    - Fix suggestions
    """
    
    # Common vulnerability patterns
    VULN_PATTERNS = [
        {
            "id": "VULN-SQL-001",
            "name": "SQL Injection",
            "pattern": r"(execute|query)\s*\(\s*['\"].*%s.*['\"]\s*%",
            "severity": VulnSeverity.CRITICAL,
            "cwe": "CWE-89",
        },
        {
            "id": "VULN-XSS-001",
            "name": "Cross-Site Scripting",
            "pattern": r"innerHTML\s*=|dangerouslySetInnerHTML",
            "severity": VulnSeverity.HIGH,
            "cwe": "CWE-79",
        },
        {
            "id": "VULN-SEC-001",
            "name": "Hardcoded Secrets",
            "pattern": r"(password|secret|api_key|token)\s*=\s*['\"][^'\"]{8,}['\"]",
            "severity": VulnSeverity.HIGH,
            "cwe": "CWE-798",
        },
        {
            "id": "VULN-CMD-001",
            "name": "Command Injection",
            "pattern": r"(os\.system|subprocess\.call|exec)\s*\(",
            "severity": VulnSeverity.CRITICAL,
            "cwe": "CWE-78",
        },
        {
            "id": "VULN-PATH-001",
            "name": "Path Traversal",
            "pattern": r"open\s*\(\s*.*\+.*\)",
            "severity": VulnSeverity.MEDIUM,
            "cwe": "CWE-22",
        },
    ]
    
    def __init__(self):
        self.scan_history: Dict[str, ScanResult] = {}
    
    async def scan_code(
        self,
        code: str,
        project_id: str,
        file_path: str = "untitled",
    ) -> Dict[str, Any]:
        """
        Scan code for vulnerabilities.
        
        Args:
            code: Source code to scan
            project_id: Project identifier
            file_path: File path for context
            
        Returns:
            Scan results with vulnerabilities
        """
        import time
        start_time = time.time()
        
        scan_id = hashlib.md5(f"{project_id}{datetime.now().isoformat()}".encode()).hexdigest()[:12]
        vulnerabilities = []
        
        lines = code.split('\n')
        for line_num, line in enumerate(lines, 1):
            for pattern in self.VULN_PATTERNS:
                if re.search(pattern["pattern"], line, re.IGNORECASE):
                    vulnerabilities.append({
                        "id": f"{scan_id}-{len(vulnerabilities)+1}",
                        "pattern_id": pattern["id"],
                        "name": pattern["name"],
                        "severity": pattern["severity"].value,
                        "cwe": pattern["cwe"],
                        "line": line_num,
                        "file": file_path,
                        "code_snippet": line.strip()[:100],
                    })
        
        duration = time.time() - start_time
        
        result = ScanResult(
            scan_id=scan_id,
            project_id=project_id,
            vulnerabilities_found=len(vulnerabilities),
            critical_count=sum(1 for v in vulnerabilities if v["severity"] == "critical"),
            high_count=sum(1 for v in vulnerabilities if v["severity"] == "high"),
            medium_count=sum(1 for v in vulnerabilities if v["severity"] == "medium"),
            low_count=sum(1 for v in vulnerabilities if v["severity"] == "low"),
            started_at=datetime.now(timezone.utc).isoformat(),
            completed_at=datetime.now(timezone.utc).isoformat(),
            duration_seconds=duration,
            files_scanned=1,
        )
        
        self.scan_history[scan_id] = result
        
        logger.info(f"Vulnerability scan completed: {scan_id}, {len(vulnerabilities)} found")
        
        return {
            "scan": result,
            "vulnerabilities": vulnerabilities,
        }
    
    def calculate_risk_score(self, vulnerabilities: List[Dict]) -> float:
        """
        Calculate overall risk score (0-100, higher = more risk).
        """
        if not vulnerabilities:
            return 0.0
        
        score = 0
        for vuln in vulnerabilities:
            severity = vuln.get("severity", "low")
            if severity == "critical":
                score += 25
            elif severity == "high":
                score += 15
            elif severity == "medium":
                score += 8
            elif severity == "low":
                score += 3
        
        return min(100, score)
    
    def get_scan_result(self, scan_id: str) -> Optional[ScanResult]:
        """Get scan result by ID."""
        return self.scan_history.get(scan_id)
    
    def generate_fix_suggestion(self, vulnerability: Dict) -> Dict[str, str]:
        """Generate fix suggestion for a vulnerability."""
        fixes = {
            "VULN-SQL-001": {
                "description": "Use parameterized queries",
                "example": "cursor.execute('SELECT * FROM users WHERE id = %s', (user_id,))",
            },
            "VULN-XSS-001": {
                "description": "Sanitize HTML content before rendering",
                "example": "Use DOMPurify.sanitize() or escape HTML entities",
            },
            "VULN-SEC-001": {
                "description": "Use environment variables for secrets",
                "example": "password = os.environ.get('DB_PASSWORD')",
            },
            "VULN-CMD-001": {
                "description": "Use subprocess with shell=False and validate input",
                "example": "subprocess.run(['cmd', arg], shell=False, check=True)",
            },
            "VULN-PATH-001": {
                "description": "Validate and sanitize file paths",
                "example": "Use os.path.abspath() and check against allowed directories",
            },
        }
        
        pattern_id = vulnerability.get("pattern_id", "")
        return fixes.get(pattern_id, {
            "description": "Review and fix manually",
            "example": "Consult security documentation",
        })
