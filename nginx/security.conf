# ============================================
# Nginx Security Headers Configuration
# ============================================
# Include this file in your nginx server block:
# include /etc/nginx/conf.d/security.conf;

# ============================================
# SSL/TLS Configuration
# ============================================

# Only use TLS 1.2 and 1.3
ssl_protocols TLSv1.2 TLSv1.3;

# Prefer server ciphers
ssl_prefer_server_ciphers on;

# Modern cipher suite
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

# SSL session settings
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 1d;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;

# ============================================
# Security Headers
# ============================================

# Content Security Policy
# Adjust based on your application's needs
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' wss:; frame-ancestors 'self'; form-action 'self'; base-uri 'self'; object-src 'none'; upgrade-insecure-requests;" always;

# Prevent clickjacking
add_header X-Frame-Options "SAMEORIGIN" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# XSS Protection (legacy, but still useful for older browsers)
add_header X-XSS-Protection "1; mode=block" always;

# HTTP Strict Transport Security (HSTS)
# 1 year with subdomains and preload
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Referrer Policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (Feature Policy replacement)
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;

# Cross-Origin policies
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;

# Prevent cross-domain policies
add_header X-Permitted-Cross-Domain-Policies "none" always;

# ============================================
# Cookie Security
# ============================================

# Ensure cookies are secure and httpOnly
# This is typically set by the application, but can be enforced here
proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";

# ============================================
# Rate Limiting
# ============================================

# Define rate limiting zones
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=register_limit:10m rate=3r/m;
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=50r/s;

# Rate limit status (for custom error pages)
limit_req_status 429;

# ============================================
# Request Size Limits
# ============================================

# Maximum request body size (adjust for file uploads)
client_max_body_size 10M;

# Maximum header size
large_client_header_buffers 4 32k;

# ============================================
# Timeout Settings
# ============================================

# Client body timeout
client_body_timeout 30s;

# Client header timeout  
client_header_timeout 30s;

# Keep-alive timeout
keepalive_timeout 65s;

# Send timeout
send_timeout 30s;

# ============================================
# Hide Server Information
# ============================================

# Hide nginx version
server_tokens off;

# Remove server header (requires headers-more module)
# more_clear_headers Server;

# ============================================
# Request Filtering
# ============================================

# Block common attack patterns
location ~* "(eval\()" { return 403; }
location ~* "(base64_encode).*\(" { return 403; }
location ~* "(javascript:).*(\()" { return 403; }
location ~* "(vbscript:)" { return 403; }
location ~* "(onmouseover)" { return 403; }

# Block access to hidden files
location ~ /\. {
    deny all;
    return 404;
}

# Block access to backup files
location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)$ {
    deny all;
    return 404;
}
