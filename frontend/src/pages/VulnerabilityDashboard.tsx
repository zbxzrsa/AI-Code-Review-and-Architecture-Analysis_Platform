/**
 * Vulnerability Dashboard Page
 * 
 * Admin interface for monitoring and managing code vulnerabilities
 * detected by the Self-Evolving Bug Fixer AI.
 */

import React, { useState, useEffect, useCallback } from 'react';
import {
  Card,
  Row,
  Col,
  Table,
  Tag,
  Button,
  Space,
  Progress,
  Tabs,
  Statistic,
  Modal,
  Typography,
  Select,
  Spin,
  Tooltip,
  Timeline,
  message,
} from 'antd';
import {
  SafetyOutlined,
  WarningOutlined,
  CheckCircleOutlined,
  ReloadOutlined,
  PlayCircleOutlined,
  PauseCircleOutlined,
  EyeOutlined,
  CodeOutlined,
  BranchesOutlined,
  ClockCircleOutlined,
  SyncOutlined,
} from '@ant-design/icons';
import type { ColumnsType } from 'antd/es/table';
import { useTranslation } from 'react-i18next';
import { apiService } from '../services/api';

const { Title, Text, Paragraph } = Typography;
const { TabPane } = Tabs;

// Types
interface Vulnerability {
  vuln_id: string;
  pattern_id: string;
  file_path: string;
  line_number: number;
  code_snippet: string;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'info';
  category: 'security' | 'performance' | 'reliability' | 'maintainability';
  description: string;
  detected_at: string;
  fix_suggestion: string;
  confidence: number;
}

interface CodeFix {
  fix_id: string;
  vuln_id: string;
  file_path: string;
  original_code: string;
  fixed_code: string;
  fix_description: string;
  status: 'pending' | 'in_progress' | 'applied' | 'verified' | 'failed' | 'rolled_back';
  applied_at: string | null;
  verified_at: string | null;
}

interface CycleResult {
  cycle: number;
  start_time: string;
  end_time: string;
  duration_seconds: number;
  vulnerabilities_found: number;
  fixes_applied: number;
  fixes_verified: number;
}

interface CycleStatus {
  running: boolean;
  cycle_count: number;
  scan_interval: number;
  summary: {
    total: number;
    by_severity: Record<string, number>;
    fixes_applied: number;
    fixes_verified: number;
  };
  recent_cycles: CycleResult[];
}

// Severity colors
const severityColors: Record<string, string> = {
  critical: 'red',
  high: 'volcano',
  medium: 'orange',
  low: 'blue',
  info: 'default',
};

// Status colors
const statusColors: Record<string, string> = {
  pending: 'default',
  in_progress: 'processing',
  applied: 'warning',
  verified: 'success',
  failed: 'error',
  rolled_back: 'error',
};

const VulnerabilityDashboard: React.FC = () => {
  const { t } = useTranslation();

  // State
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [fixes, setFixes] = useState<CodeFix[]>([]);
  const [cycleStatus, setCycleStatus] = useState<CycleStatus | null>(null);
  const [loading, setLoading] = useState(true);
  const [scanning, setScanning] = useState(false);
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);
  const [selectedFix, setSelectedFix] = useState<CodeFix | null>(null);
  const [detailsModalOpen, setDetailsModalOpen] = useState(false);
  const [fixModalOpen, setFixModalOpen] = useState(false);
  const [severityFilter, setSeverityFilter] = useState<string>('all');
  const [categoryFilter, setCategoryFilter] = useState<string>('all');

  // Fetch data from API with fallback
  const fetchData = useCallback(async () => {
    try {
      setLoading(true);

      // Try to fetch from API first
      try {
        const response = await apiService.analysis.getVulnerabilities();
        if (response.data?.items) {
          const mappedVulns = response.data.items.map((v: any) => ({
            vuln_id: v.id,
            pattern_id: v.category,
            file_path: v.file,
            line_number: v.line,
            code_snippet: '',
            severity: v.severity,
            category: 'security',
            description: v.title,
            detected_at: v.discoveredAt,
            fix_suggestion: '',
            confidence: 0.9,
          }));
          setVulnerabilities(mappedVulns);
          setLoading(false);
          return;
        }
      } catch {
        // Fall through to mock data
      }

      // Fallback mock data
      const mockVulnerabilities: Vulnerability[] = [
        {
          vuln_id: 'vuln-001',
          pattern_id: 'SEC-001',
          file_path: 'backend/shared/security/auth.py',
          line_number: 19,
          code_snippet: 'SECRET_KEY = os.getenv("JWT_SECRET_KEY", "default")',
          severity: 'critical',
          category: 'security',
          description: 'Hardcoded default secret key',
          detected_at: new Date().toISOString(),
          fix_suggestion: 'Remove default fallback and raise error if not set',
          confidence: 0.95,
        },
        {
          vuln_id: 'vuln-002',
          pattern_id: 'REL-001',
          file_path: 'backend/shared/services/reliability.py',
          line_number: 41,
          code_snippet: 'expire = datetime.utcnow() + expires_delta',
          severity: 'medium',
          category: 'reliability',
          description: 'Using deprecated datetime.utcnow()',
          detected_at: new Date().toISOString(),
          fix_suggestion: 'Use datetime.now(timezone.utc) instead',
          confidence: 0.9,
        },
        {
          vuln_id: 'vuln-003',
          pattern_id: 'SEC-003',
          file_path: 'backend/shared/security/auth.py',
          line_number: 97,
          code_snippet: 'payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])',
          severity: 'high',
          category: 'security',
          description: 'JWT decode without proper validation options',
          detected_at: new Date().toISOString(),
          fix_suggestion: 'Add audience, issuer, and required claims validation',
          confidence: 0.88,
        },
      ];

      const mockFixes: CodeFix[] = [
        {
          fix_id: 'fix-001',
          vuln_id: 'vuln-001',
          file_path: 'backend/shared/security/auth.py',
          original_code: 'SECRET_KEY = os.getenv("JWT_SECRET_KEY", "default")',
          fixed_code: 'SECRET_KEY = os.getenv("JWT_SECRET_KEY")\nif not SECRET_KEY:\n    raise ValueError("JWT_SECRET_KEY must be set")',
          fix_description: 'Remove default fallback for secret key',
          status: 'verified',
          applied_at: new Date().toISOString(),
          verified_at: new Date().toISOString(),
        },
        {
          fix_id: 'fix-002',
          vuln_id: 'vuln-002',
          file_path: 'backend/shared/services/reliability.py',
          original_code: 'datetime.utcnow()',
          fixed_code: 'datetime.now(timezone.utc)',
          fix_description: 'Replace deprecated datetime.utcnow()',
          status: 'applied',
          applied_at: new Date().toISOString(),
          verified_at: null,
        },
      ];

      const mockCycleStatus: CycleStatus = {
        running: true,
        cycle_count: 15,
        scan_interval: 3600,
        summary: {
          total: 3,
          by_severity: { critical: 1, high: 1, medium: 1 },
          fixes_applied: 2,
          fixes_verified: 1,
        },
        recent_cycles: [
          {
            cycle: 15,
            start_time: new Date(Date.now() - 3600000).toISOString(),
            end_time: new Date().toISOString(),
            duration_seconds: 45,
            vulnerabilities_found: 3,
            fixes_applied: 1,
            fixes_verified: 1,
          },
          {
            cycle: 14,
            start_time: new Date(Date.now() - 7200000).toISOString(),
            end_time: new Date(Date.now() - 7200000 + 50000).toISOString(),
            duration_seconds: 50,
            vulnerabilities_found: 5,
            fixes_applied: 2,
            fixes_verified: 2,
          },
        ],
      };

      setVulnerabilities(mockVulnerabilities);
      setFixes(mockFixes);
      setCycleStatus(mockCycleStatus);
    } catch (error) {
      console.error('Failed to fetch data:', error);
      message.error('Failed to load vulnerability data');
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchData();
    const interval = setInterval(fetchData, 30000);
    return () => clearInterval(interval);
  }, [fetchData]);

  // Handlers
  const handleScan = async () => {
    setScanning(true);
    message.loading({ content: 'Scanning codebase...', key: 'scan' });
    await new Promise((resolve) => setTimeout(resolve, 2000));
    await fetchData();
    message.success({ content: 'Scan complete!', key: 'scan' });
    setScanning(false);
  };

  const handleApplyFix = async (_vulnId: string) => {
    message.loading({ content: 'Applying fix...', key: 'fix' });
    await new Promise((resolve) => setTimeout(resolve, 1000));
    message.success({ content: 'Fix applied successfully!', key: 'fix' });
    await fetchData();
  };

  const handleViewDetails = (vuln: Vulnerability) => {
    setSelectedVuln(vuln);
    setDetailsModalOpen(true);
  };

  const handleViewFix = (fix: CodeFix) => {
    setSelectedFix(fix);
    setFixModalOpen(true);
  };

  // Filter vulnerabilities
  const filteredVulnerabilities = vulnerabilities.filter((vuln) => {
    if (severityFilter !== 'all' && vuln.severity !== severityFilter) return false;
    if (categoryFilter !== 'all' && vuln.category !== categoryFilter) return false;
    return true;
  });

  // Vulnerability table columns
  const vulnColumns: ColumnsType<Vulnerability> = [
    {
      title: 'Severity',
      dataIndex: 'severity',
      key: 'severity',
      width: 100,
      render: (severity: string) => (
        <Tag color={severityColors[severity]} icon={<WarningOutlined />}>
          {severity.toUpperCase()}
        </Tag>
      ),
    },
    {
      title: 'File',
      dataIndex: 'file_path',
      key: 'file_path',
      render: (path: string) => (
        <Text code style={{ fontSize: 12 }}>
          {path.split('/').pop()}
        </Text>
      ),
    },
    {
      title: 'Line',
      dataIndex: 'line_number',
      key: 'line_number',
      width: 80,
    },
    {
      title: 'Description',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
    },
    {
      title: 'Confidence',
      dataIndex: 'confidence',
      key: 'confidence',
      width: 120,
      render: (confidence: number) => (
        <Progress percent={Math.round(confidence * 100)} size="small" />
      ),
    },
    {
      title: 'Actions',
      key: 'actions',
      width: 120,
      render: (_: unknown, record: Vulnerability) => (
        <Space>
          <Tooltip title="View Details">
            <Button
              type="text"
              icon={<EyeOutlined />}
              onClick={() => handleViewDetails(record)}
            />
          </Tooltip>
          <Tooltip title="Apply Fix">
            <Button
              type="text"
              icon={<CodeOutlined />}
              onClick={() => handleApplyFix(record.vuln_id)}
            />
          </Tooltip>
        </Space>
      ),
    },
  ];

  // Fix table columns
  const fixColumns: ColumnsType<CodeFix> = [
    {
      title: 'Status',
      dataIndex: 'status',
      key: 'status',
      width: 120,
      render: (status: string) => (
        <Tag color={statusColors[status]}>{status.toUpperCase()}</Tag>
      ),
    },
    {
      title: 'File',
      dataIndex: 'file_path',
      key: 'file_path',
      render: (path: string) => (
        <Text code style={{ fontSize: 12 }}>
          {path.split('/').pop()}
        </Text>
      ),
    },
    {
      title: 'Description',
      dataIndex: 'fix_description',
      key: 'fix_description',
      ellipsis: true,
    },
    {
      title: 'Applied At',
      dataIndex: 'applied_at',
      key: 'applied_at',
      width: 180,
      render: (date: string | null) =>
        date ? new Date(date).toLocaleString() : '-',
    },
    {
      title: 'Verified',
      dataIndex: 'verified_at',
      key: 'verified_at',
      width: 100,
      render: (date: string | null) =>
        date ? (
          <CheckCircleOutlined style={{ color: 'green', fontSize: 18 }} />
        ) : (
          <ClockCircleOutlined style={{ color: 'orange', fontSize: 18 }} />
        ),
    },
    {
      title: 'Actions',
      key: 'actions',
      width: 80,
      render: (_: unknown, record: CodeFix) => (
        <Tooltip title="View Fix">
          <Button
            type="text"
            icon={<BranchesOutlined />}
            onClick={() => handleViewFix(record)}
          />
        </Tooltip>
      ),
    },
  ];

  if (loading) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: 400 }}>
        <Spin size="large" />
      </div>
    );
  }

  return (
    <div style={{ padding: 24 }}>
      {/* Header */}
      <Row justify="space-between" align="middle" style={{ marginBottom: 24 }}>
        <Col>
          <Title level={3} style={{ margin: 0 }}>
            <SafetyOutlined style={{ marginRight: 8 }} />
            {t('vulnerabilities.title', 'Vulnerability Dashboard')}
          </Title>
        </Col>
        <Col>
          <Space>
            <Tag color={cycleStatus?.running ? 'green' : 'default'}>
              {cycleStatus?.running ? (
                <>
                  <SyncOutlined spin /> Cycle #{cycleStatus.cycle_count}
                </>
              ) : (
                <>
                  <PauseCircleOutlined /> Stopped
                </>
              )}
            </Tag>
            <Button
              type="primary"
              icon={scanning ? <SyncOutlined spin /> : <ReloadOutlined />}
              onClick={handleScan}
              loading={scanning}
            >
              Scan Now
            </Button>
          </Space>
        </Col>
      </Row>

      {/* Summary Cards */}
      <Row gutter={16} style={{ marginBottom: 24 }}>
        <Col xs={24} sm={12} md={6}>
          <Card>
            <Statistic
              title={t('vulnerabilities.total', 'Total Vulnerabilities')}
              value={cycleStatus?.summary.total || 0}
              prefix={<SafetyOutlined />}
              valueStyle={{ color: '#cf1322' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} md={6}>
          <Card>
            <Statistic
              title={t('vulnerabilities.fixes_applied', 'Fixes Applied')}
              value={cycleStatus?.summary.fixes_applied || 0}
              prefix={<CodeOutlined />}
              valueStyle={{ color: '#faad14' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} md={6}>
          <Card>
            <Statistic
              title={t('vulnerabilities.fixes_verified', 'Fixes Verified')}
              value={cycleStatus?.summary.fixes_verified || 0}
              prefix={<CheckCircleOutlined />}
              valueStyle={{ color: '#52c41a' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} md={6}>
          <Card>
            <Statistic
              title={t('vulnerabilities.cycle_status', 'Cycle Status')}
              value={cycleStatus?.running ? 'Running' : 'Stopped'}
              prefix={
                cycleStatus?.running ? (
                  <PlayCircleOutlined />
                ) : (
                  <PauseCircleOutlined />
                )
              }
              valueStyle={{ color: cycleStatus?.running ? '#52c41a' : '#8c8c8c' }}
            />
          </Card>
        </Col>
      </Row>

      {/* Severity Breakdown */}
      <Card title="Severity Breakdown" style={{ marginBottom: 24 }}>
        <Row gutter={16}>
          {Object.entries(cycleStatus?.summary.by_severity || {}).map(
            ([severity, count]) => (
              <Col key={severity} xs={12} sm={6}>
                <Space>
                  <Tag color={severityColors[severity]}>
                    {severity.toUpperCase()}
                  </Tag>
                  <Text strong>{count}</Text>
                </Space>
              </Col>
            )
          )}
        </Row>
      </Card>

      {/* Main Content Tabs */}
      <Card>
        <Tabs defaultActiveKey="vulnerabilities">
          <TabPane tab="Vulnerabilities" key="vulnerabilities">
            <Space style={{ marginBottom: 16 }}>
              <Select
                style={{ width: 120 }}
                value={severityFilter}
                onChange={(value: string) => setSeverityFilter(value)}
                options={[
                  { value: 'all', label: 'All Severity' },
                  { value: 'critical', label: 'Critical' },
                  { value: 'high', label: 'High' },
                  { value: 'medium', label: 'Medium' },
                  { value: 'low', label: 'Low' },
                ]}
              />
              <Select
                style={{ width: 140 }}
                value={categoryFilter}
                onChange={(value: string) => setCategoryFilter(value)}
                options={[
                  { value: 'all', label: 'All Categories' },
                  { value: 'security', label: 'Security' },
                  { value: 'reliability', label: 'Reliability' },
                  { value: 'performance', label: 'Performance' },
                ]}
              />
            </Space>
            <Table
              columns={vulnColumns}
              dataSource={filteredVulnerabilities}
              rowKey="vuln_id"
              pagination={{ pageSize: 10 }}
            />
          </TabPane>

          <TabPane tab="Applied Fixes" key="fixes">
            <Table
              columns={fixColumns}
              dataSource={fixes}
              rowKey="fix_id"
              pagination={{ pageSize: 10 }}
            />
          </TabPane>

          <TabPane tab="Cycle History" key="history">
            <Timeline mode="left">
              {cycleStatus?.recent_cycles.map((cycle) => (
                <Timeline.Item
                  key={cycle.cycle}
                  color={cycle.fixes_verified > 0 ? 'green' : 'blue'}
                  label={new Date(cycle.end_time).toLocaleTimeString()}
                >
                  <Text strong>Cycle #{cycle.cycle}</Text>
                  <br />
                  <Text type="secondary">
                    Duration: {cycle.duration_seconds}s | Found:{' '}
                    {cycle.vulnerabilities_found} | Fixed: {cycle.fixes_applied} |
                    Verified: {cycle.fixes_verified}
                  </Text>
                </Timeline.Item>
              ))}
            </Timeline>
          </TabPane>
        </Tabs>
      </Card>

      {/* Vulnerability Details Modal */}
      <Modal
        title={
          <Space>
            Vulnerability Details
            {selectedVuln && (
              <Tag color={severityColors[selectedVuln.severity]}>
                {selectedVuln.severity.toUpperCase()}
              </Tag>
            )}
          </Space>
        }
        open={detailsModalOpen}
        onCancel={() => setDetailsModalOpen(false)}
        footer={[
          <Button key="close" onClick={() => setDetailsModalOpen(false)}>
            Close
          </Button>,
          <Button
            key="fix"
            type="primary"
            onClick={() => {
              if (selectedVuln) handleApplyFix(selectedVuln.vuln_id);
              setDetailsModalOpen(false);
            }}
          >
            Apply Fix
          </Button>,
        ]}
        width={700}
      >
        {selectedVuln && (
          <div>
            <Paragraph>
              <Text strong>File: </Text>
              <Text code>
                {selectedVuln.file_path}:{selectedVuln.line_number}
              </Text>
            </Paragraph>

            <Paragraph>
              <Text strong>Description: </Text>
              {selectedVuln.description}
            </Paragraph>

            <Paragraph>
              <Text strong>Code Snippet:</Text>
            </Paragraph>
            <pre
              style={{
                background: '#1e1e1e',
                color: '#d4d4d4',
                padding: 16,
                borderRadius: 4,
                overflow: 'auto',
              }}
            >
              {selectedVuln.code_snippet}
            </pre>

            <Paragraph>
              <Text strong>Suggested Fix:</Text>
            </Paragraph>
            <pre
              style={{
                background: '#1e3a1e',
                color: '#4caf50',
                padding: 16,
                borderRadius: 4,
                overflow: 'auto',
              }}
            >
              {selectedVuln.fix_suggestion}
            </pre>

            <Row gutter={16}>
              <Col span={8}>
                <Text type="secondary">Pattern ID: </Text>
                <Text>{selectedVuln.pattern_id}</Text>
              </Col>
              <Col span={8}>
                <Text type="secondary">Category: </Text>
                <Text>{selectedVuln.category}</Text>
              </Col>
              <Col span={8}>
                <Text type="secondary">Confidence: </Text>
                <Text>{(selectedVuln.confidence * 100).toFixed(0)}%</Text>
              </Col>
            </Row>
          </div>
        )}
      </Modal>

      {/* Fix Details Modal */}
      <Modal
        title="Fix Details"
        open={fixModalOpen}
        onCancel={() => setFixModalOpen(false)}
        footer={[
          <Button key="close" onClick={() => setFixModalOpen(false)}>
            Close
          </Button>,
        ]}
        width={700}
      >
        {selectedFix && (
          <div>
            <Paragraph>
              <Text strong>File: </Text>
              <Text code>{selectedFix.file_path}</Text>
            </Paragraph>

            <Paragraph>
              <Text strong>Original Code:</Text>
            </Paragraph>
            <pre
              style={{
                background: '#3a1e1e',
                color: '#f44336',
                padding: 16,
                borderRadius: 4,
                overflow: 'auto',
              }}
            >
              - {selectedFix.original_code}
            </pre>

            <Paragraph>
              <Text strong>Fixed Code:</Text>
            </Paragraph>
            <pre
              style={{
                background: '#1e3a1e',
                color: '#4caf50',
                padding: 16,
                borderRadius: 4,
                overflow: 'auto',
              }}
            >
              + {selectedFix.fixed_code}
            </pre>

            <Paragraph>
              <Text strong>Status: </Text>
              <Tag color={statusColors[selectedFix.status]}>
                {selectedFix.status.toUpperCase()}
              </Tag>
            </Paragraph>
          </div>
        )}
      </Modal>
    </div>
  );
};

export default VulnerabilityDashboard;
